<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ PATHAK MEMORY ADMIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; font-family: 'Roboto', sans-serif; color: white; padding-bottom: 60px; }
        .container { max-width: 600px; margin: auto; padding: 5px; }
        
        .sticky-nav { position: sticky; top: 0; z-index: 99; background: #000; padding: 5px 0; border-bottom: 1px solid #222; }
        
        /* FILTERS */
        .filter-box { display: flex; gap: 5px; margin-bottom: 5px; padding: 0 5px; }
        .filter-btn { flex: 1; padding: 10px; background: #111; color: #666; border: 1px solid #333; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; }
        .filter-btn.active { background: #00e5ff; color: #000; border-color: #00e5ff; }

        /* TABS */
        .tabs { display: flex; gap: 5px; background: #1a1a1a; padding: 5px; border-radius: 8px; margin: 0 5px; }
        .tab { flex: 1; padding: 8px; text-align: center; font-weight: bold; font-size: 11px; color: #666; cursor: pointer; border-radius: 6px; }
        .tab.active { background: #fff; color: #000; }

        /* CARD */
        .card { background: #0f0f0f; border: 1px solid #222; border-radius: 12px; margin: 10px 5px; padding: 10px; }
        
        /* UPI STRIP */
        .upi-strip { 
            background: linear-gradient(90deg, #111, #1a1a1a); 
            padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
            border: 1px dashed #333; cursor: pointer; margin-bottom: 8px;
        }
        .upi-val { font-size: 14px; color: #00e5ff; font-weight: bold; }
        .copy-hint { font-size: 9px; color: #555; font-weight: bold; }

        .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .offer-title { font-size: 10px; color: #888; }
        .amt-tag { font-size: 22px; font-weight: 900; color: #fff; }

        /* ICONS GRID */
        .app-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
        .app-btn { 
            background: #181818; border: 1px solid #333; border-radius: 6px; padding: 8px 0; 
            text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center;
        }
        .app-btn:active { background: #333; }
        .app-btn img { width: 24px; height: 24px; margin-bottom: 3px; }
        .app-lbl { font-size: 8px; font-weight: bold; color: #aaa; text-transform: uppercase; }

        .btn-done { width: 100%; background: #00e5ff; color: #000; border: none; padding: 12px; border-radius: 6px; font-weight: 900; cursor: pointer; font-size: 12px; }
        
        .hidden { display: none !important; }
        .loader { text-align: center; padding: 50px; color: #00e5ff; font-size: 12px; font-weight: bold; }
        #toast { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 6px 15px; border-radius: 20px; font-size: 10px; font-weight: 900; display: none; z-index: 999; }
    </style>
</head>
<body>

<div id="toast">COPIED</div>

<div class="sticky-nav">
    <div class="filter-box">
        <button class="filter-btn" id="btn-1" onclick="changeReport(1)">TODAY</button>
        <button class="filter-btn" id="btn-3" onclick="changeReport(3)">48 HRS</button>
        <button class="filter-btn" id="btn-4" onclick="changeReport(4)">7 DAYS</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('tasks')">TASKS (<span id="tc">0</span>)</div>
        <div class="tab" onclick="switchTab('referrals')">REFS (<span id="rc">0</span>)</div>
        <div class="tab" onclick="switchTab('history')">HISTORY</div>
    </div>
</div>

<div class="container">
    <div id="loader" class="loader">LOADING...</div>
    <div id="tasks-area"></div>
    <div id="referrals-area" class="hidden"></div>
    <div id="history-area" class="hidden"></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfjyg_o0a_BUgiC0Iuoit3OTtzBHhkvVf8kg6XeI0DaCKVpBsbljCbpK-Tbb7uk-Dqvg/exec";
    const AUTH = "8df0570da65f3a1798408c942b82839a";
    
    // --- MEMORY SYSTEM: YAAD RAKHEGA LAST OPTION ---
    let currentReport = localStorage.getItem('last_report_id') || 1; 
    let paidSet = new Set(), leads = [], offers = {};

    // Start
    init();

    async function init() {
        // Highlight Saved Button Immediately
        updateBtnUI(currentReport);
        loadData();
    }

    function changeReport(id) {
        currentReport = id;
        localStorage.setItem('last_report_id', id); // SAVE TO MEMORY
        updateBtnUI(id);
        loadData();
    }

    function updateBtnUI(id) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('btn-' + id);
        if(btn) btn.classList.add('active');
    }

    async function loadData() {
        document.getElementById('loader').classList.remove('hidden');
        ['tasks-area','referrals-area','history-area'].forEach(id => document.getElementById(id).innerHTML = '');

        try {
            if(Object.keys(offers).length === 0) {
                const [rSheet, rOffer] = await Promise.all([fetch(SCRIPT_URL), fetch('offers.json')]);
                const dSheet = await rSheet.json();
                const dOffer = await rOffer.json();
                dSheet.forEach(k => paidSet.add(k));
                dOffer.forEach(o => {
                    offers[o.cid || o.id] = { t: o.title, u: parseInt(o.user_payout.replace(/\D/g,'')) || 6, r: parseInt(o.refer_payout.replace(/\D/g,'')) || 2 };
                });
            }

            const target = `https://panel.visioncamp.in/api.php?auth-token=${AUTH}&report=${currentReport}`;
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`,
                `https://corsproxy.io/?${encodeURIComponent(target)}`,
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(target)}`
            ];

            let success = false;
            for(let p of proxies) {
                try {
                    const res = await fetch(p);
                    if(res.ok) {
                        const d = await res.json();
                        leads = d.data || d;
                        success = true;
                        break;
                    }
                } catch(e) {}
            }

            document.getElementById('loader').classList.add('hidden');
            if(success) render();

        } catch(e) { console.log(e); }
    }

    function render() {
        let tA = document.getElementById('tasks-area'), rA = document.getElementById('referrals-area'), hA = document.getElementById('history-area');
        let rG = {}, tc = 0, rc = 0;

        [...leads].reverse().forEach(l => {
            if(l.status.toLowerCase() !== 'approved') return;
            let o = offers[l.offerid] || { t: `Offer ${l.offerid}`, u: 6, r: 2 };
            let sk = `${l.p1}_${l.offerid}_SELF`;
            let rk = `${l.p2}_${l.offerid}_REF`;

            if(paidSet.has(sk)) {
                hA.innerHTML += `<div class="card" style="opacity:0.5; font-size:10px;">
                    <div style="color:#00e5ff">${l.p1}</div><div>₹${o.u} Paid</div>
                </div>`;
            } else {
                tc++;
                tA.innerHTML += makeCard(l.p1, o.t, o.u, sk);
            }

            if(l.p2 && l.p2.length > 5) {
                if(!rG[l.p2]) rG[l.p2] = { total: 0, keys: [] };
                rG[l.p2].total += o.r; rG[l.p2].keys.push(rk);
            }
        });

        for (let [upi, d] of Object.entries(rG)) {
            if(d.keys.every(k => paidSet.has(k))) continue;
            rc++;
            rA.innerHTML += makeCard(upi, `${d.keys.length} REFERRALS`, d.total, JSON.stringify(d.keys));
        }

        document.getElementById('tc').innerText = tc;
        document.getElementById('rc').innerText = rc;
    }

    function makeCard(upi, title, amt, key) {
        return `
            <div class="card" id="card-${key}">
                <div class="upi-strip" onclick="copyUPI('${upi}')">
                    <div class="upi-val">${upi}</div>
                    <div class="copy-hint">TAP COPY</div>
                </div>
                
                <div class="info-row">
                    <div class="offer-title">${title}</div>
                    <div class="amt-tag">₹${amt}</div>
                </div>

                <div class="app-grid">
                    <div class="app-btn" onclick="openApp('fam_one', '${upi}')">
                        <img src="https://img.icons8.com/color/48/wallet.png"><div class="app-lbl">FAM.1</div>
                    </div>
                    <div class="app-btn" onclick="openApp('fam_app', '${upi}')">
                        <img src="https://img.icons8.com/color/48/wallet.png"><div class="app-lbl">FAM APP</div>
                    </div>
                    <div class="app-btn" onclick="openApp('pe_app', '${upi}')">
                        <img src="https://img.icons8.com/color/48/phone-pe.png"><div class="app-lbl">PE APP</div>
                    </div>
                    <div class="app-btn" onclick="openApp('pe_pay', '${upi}', '${amt}')">
                        <img src="https://img.icons8.com/color/48/phone-pe.png"><div class="app-lbl">PE PAY</div>
                    </div>
                    <div class="app-btn" onclick="openApp('pay_app', '${upi}')">
                        <img src="https://img.icons8.com/color/48/paytm.png"><div class="app-lbl">PTM APP</div>
                    </div>
                    <div class="app-btn" onclick="openApp('pay_scan', '${upi}')">
                        <img src="https://img.icons8.com/color/48/paytm.png"><div class="app-lbl">PTM PAY</div>
                    </div>
                </div>

                <button class="btn-done" onclick="markPaid('${key}')">✅ MARK DONE</button>
            </div>`;
    }

    function openApp(app, upi, amt) {
        navigator.clipboard.writeText(upi);
        const t = document.getElementById('toast');
        t.innerText = "COPIED"; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1000);
        
        setTimeout(() => {
            if(app === 'fam_one') window.location.href = `https://fam.one/${upi}`;
            if(app === 'fam_app') window.location.href = "fampay://";
            if(app === 'pe_app') window.location.href = "phonepe://";
            if(app === 'pe_pay') window.location.href = `phonepe://pay?pa=${upi}&pn=User&am=${amt}&cu=INR`;
            if(app === 'pay_app') window.location.href = "paytmmp://";
            if(app === 'pay_scan') window.location.href = "paytmmp://pay?pa=" + upi;
        }, 300);
    }

    function copyUPI(txt) {
        navigator.clipboard.writeText(txt);
        document.getElementById('toast').style.display = 'block'; setTimeout(() => document.getElementById('toast').style.display = 'none', 1000);
    }

    function markPaid(key) {
        if(confirm("Paid?")) {
            document.getElementById(`card-${key}`).style.display = 'none';
            const kArr = key.startsWith('[') ? JSON.parse(key) : [key];
            kArr.forEach(k => fetch(SCRIPT_URL + `?action=pay&key=${encodeURIComponent(k)}`, { mode: 'no-cors' }));
        }
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        ['tasks-area','referrals-area','history-area'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(t + '-area').classList.remove('hidden');
    }
</script>
</body>
</html>
