<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ FAST ADMIN PANEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #050505; font-family: 'Roboto', sans-serif; color: white; padding-bottom: 50px; }
        .container { max-width: 600px; margin: auto; padding: 5px; }
        
        /* 1. COMPACT HEADER & FILTERS */
        .sticky-header { position: sticky; top: 0; z-index: 999; background: #050505; border-bottom: 1px solid #222; padding-bottom: 5px; }
        
        .filter-row { display: flex; gap: 5px; padding: 8px 5px; }
        .filter-btn { 
            flex: 1; padding: 6px; background: #1a1a1a; color: #888; border: 1px solid #333; 
            border-radius: 4px; font-weight: bold; font-size: 10px; cursor: pointer; text-transform: uppercase;
        }
        .filter-btn.active { background: #00e5ff; color: #000; border-color: #00e5ff; }

        .stats-row { display: flex; justify-content: space-between; padding: 0 10px; font-size: 10px; color: #555; font-weight: bold; }
        .refresh-btn { color: #00e5ff; cursor: pointer; }

        /* 2. SUPER COMPACT CARD */
        .card { 
            background: #111; border-bottom: 1px solid #222; padding: 8px; 
            display: flex; flex-direction: column; gap: 5px; 
        }
        
        /* Top Row: UPI & Amount */
        .card-top { display: flex; justify-content: space-between; align-items: center; }
        .upi-box { 
            background: #1a1a1a; color: #00e5ff; padding: 4px 8px; border-radius: 4px; 
            font-size: 12px; font-weight: bold; border: 1px dashed #333; cursor: pointer;
            flex-grow: 1; margin-right: 10px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .amt-box { font-size: 16px; font-weight: 900; color: #fff; min-width: 40px; text-align: right; }

        /* Middle Row: Offer Name */
        .offer-name { font-size: 9px; color: #666; }

        /* Bottom Row: Icons & Done Button */
        .action-row { display: flex; gap: 5px; height: 30px; }
        
        /* Small Icons */
        .icon-btn { 
            flex: 1; background: #181818; border: 1px solid #333; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .icon-btn:active { background: #333; }
        .icon-btn img { width: 20px; height: 20px; }
        
        /* Done Button */
        .done-btn { 
            flex: 2; background: #00e5ff; color: #000; border: none; border-radius: 4px; 
            font-weight: 900; font-size: 10px; cursor: pointer;
        }

        .loader { text-align: center; padding: 20px; font-size: 11px; color: #888; }
        .hidden { display: none !important; }
        
        /* Toast Notification */
        #toast { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: #333; color: #fff; padding: 5px 15px; border-radius: 20px; 
            font-size: 10px; font-weight: bold; display: none; z-index: 1000; 
        }
    </style>
</head>
<body>

<div id="toast">COPIED</div>

<div class="container">
    <div class="sticky-header">
        <div class="filter-row">
            <button class="filter-btn" id="btn-1" onclick="setReport(1)">TODAY</button>
            <button class="filter-btn" id="btn-3" onclick="setReport(3)">YESTERDAY</button>
            <button class="filter-btn" id="btn-4" onclick="setReport(4)">7 DAYS</button>
        </div>
        <div class="stats-row">
            <span id="status-text">WAITING...</span>
            <span class="refresh-btn" onclick="fetchData()">ðŸ”„ REFRESH</span>
        </div>
    </div>

    <div id="loader" class="loader">LOADING DATA...</div>
    <div id="list-area"></div>
</div>

<script>
    // --- CONFIGURATION ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfjyg_o0a_BUgiC0Iuoit3OTtzBHhkvVf8kg6XeI0DaCKVpBsbljCbpK-Tbb7uk-Dqvg/exec";
    const AUTH = "8df0570da65f3a1798408c942b82839a";
    
    // --- STATE MANAGEMENT ---
    let currentReport = localStorage.getItem('last_report') || 1; // Remember last choice
    let leads = [], offers = {};

    // --- INITIALIZE ---
    // Update button active state immediately
    updateButtons();
    init();

    async function init() {
        // Load offers once
        try {
            const rOffer = await fetch('offers.json');
            const dOffer = await rOffer.json();
            dOffer.forEach(o => {
                offers[o.cid || o.id] = { 
                    t: o.title, 
                    u: parseInt(o.user_payout.replace(/\D/g,'')) || 6 
                };
            });
            fetchData();
        } catch(e) { console.log(e); fetchData(); }
    }

    // --- ROBUST DATA FETCHING (MULTI-PROXY) ---
    async function fetchData() {
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('list-area').innerHTML = '';
        document.getElementById('status-text').innerText = "CONNECTING...";
        
        const target = `https://panel.visioncamp.in/api.php?auth-token=${AUTH}&report=${currentReport}`;
        
        // 3 Strong Proxies
        const proxies = [
            `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`,
            `https://corsproxy.io/?${encodeURIComponent(target)}`,
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(target)}`
        ];

        let success = false;
        for (let url of proxies) {
            try {
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    leads = data.data || data;
                    success = true;
                    break; // Stop loop if success
                }
            } catch (e) { console.log("Proxy fail, trying next..."); }
        }

        document.getElementById('loader').classList.add('hidden');
        
        if (success) {
            document.getElementById('status-text').innerText = `DATA: ${leads.length}`;
            render();
        } else {
            document.getElementById('status-text').innerText = "SERVER ERROR âŒ";
            document.getElementById('loader').innerHTML = "FAILED. TRY REFRESH BUTTON.";
            document.getElementById('loader').classList.remove('hidden');
        }
    }

    // --- RENDER (NO RELOAD) ---
    function render() {
        const area = document.getElementById('list-area');
        area.innerHTML = '';

        [...leads].reverse().forEach(l => {
            if (l.status.toLowerCase() !== 'approved') return;
            
            // Check Local Storage for locally hidden items (Temporary cache)
            if (localStorage.getItem(`hide_${l.p1}_${l.offerid}`)) return;

            let o = offers[l.offerid] || { t: `Offer ${l.offerid}`, u: 6 };
            let key = `${l.p1}_${l.offerid}`;
            let safeKey = key.replace(/[^a-zA-Z0-9]/g, ''); // CSS safe ID

            area.innerHTML += `
                <div class="card" id="card-${safeKey}">
                    <div class="card-top">
                        <div class="upi-box" onclick="copyUPI('${l.p1}')">${l.p1} ðŸ“‹</div>
                        <div class="amt-box">â‚¹${o.u}</div>
                    </div>
                    <div class="offer-name">${o.t}</div>
                    
                    <div class="action-row">
                        <div class="icon-btn" onclick="openLink('https://fam.one/${l.p1}')" style="border-color:#F89F1E55">
                            <img src="https://img.icons8.com/color/48/wallet.png">
                        </div>
                        <div class="icon-btn" onclick="openLink('fampay://')" style="border-color:#F89F1E55">
                            <img src="https://img.icons8.com/color/48/wallet.png">
                        </div>
                        <div class="icon-btn" onclick="openLink('phonepe://')" style="border-color:#5f259f55">
                            <img src="https://img.icons8.com/color/48/phone-pe.png">
                        </div>
                        <div class="icon-btn" onclick="openLink('phonepe://pay?pa=${l.p1}&pn=User&cu=INR')" style="border-color:#5f259f55">
                            <img src="https://img.icons8.com/color/48/phone-pe.png">
                        </div>
                        <button class="done-btn" onclick="markDone('${l.p1}', '${safeKey}', '${key}')">DONE</button>
                    </div>
                </div>
            `;
        });
        
        if(area.innerHTML === '') document.getElementById('loader').innerText = "NO DATA FOUND";
    }

    // --- ACTIONS (NO RELOAD) ---

    function copyUPI(text) {
        navigator.clipboard.writeText(text);
        showToast("COPIED");
    }

    function openLink(url) {
        window.location.href = url;
    }

    function markDone(upi, htmlId, fullKey) {
        // 1. Hide Immediately (Visual Feedback)
        const el = document.getElementById(`card-${htmlId}`);
        if(el) el.style.display = 'none';

        // 2. Save to Local Storage (so it stays hidden on refresh)
        localStorage.setItem(`hide_${fullKey}`, 'true');

        // 3. Send to Server (Background)
        fetch(SCRIPT_URL + `?action=pay&key=${encodeURIComponent(fullKey)}_SELF`, { mode: 'no-cors' });
        
        showToast("MARKED DONE");
    }

    // --- FILTER LOGIC ---
    function setReport(id) {
        currentReport = id;
        localStorage.setItem('last_report', id); // Save choice
        updateButtons();
        fetchData();
    }

    function updateButtons() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${currentReport}`).classList.add('active');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1000);
    }
</script>
</body>
</html>
