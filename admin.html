<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’Ž PATHAK GOLD EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; font-family: 'Roboto', sans-serif; color: white; padding-bottom: 80px; }
        .container { max-width: 600px; margin: auto; padding: 10px; }
        
        /* HEADER SECTION */
        .sticky-header { position: sticky; top: 0; z-index: 999; background: #000; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        /* FILTERS */
        .filter-row { display: flex; gap: 8px; padding: 10px 5px; }
        .filter-btn { flex: 1; padding: 12px; background: #1a1a1a; color: #888; border: 1px solid #333; border-radius: 8px; font-weight: bold; font-size: 11px; cursor: pointer; }
        .filter-btn.active { background: #00e5ff; color: #000; border-color: #00e5ff; box-shadow: 0 0 10px rgba(0,229,255,0.4); }

        /* TABS */
        .tabs { display: flex; gap: 5px; background: #111; padding: 5px; border-radius: 10px; margin: 0 5px; border: 1px solid #222; }
        .tab { flex: 1; padding: 10px; text-align: center; font-weight: bold; font-size: 12px; color: #555; cursor: pointer; border-radius: 8px; }
        .tab.active { background: #fff; color: #000; }

        /* MAIN CARD DESIGN */
        .card { background: #0a0a0a; border: 1px solid #222; border-radius: 15px; margin-bottom: 15px; padding: 15px; position: relative; }
        
        /* UPI BOX */
        .upi-box { 
            background: linear-gradient(90deg, #111, #1a1a1a); 
            padding: 12px; border-radius: 8px; text-align: center; 
            border: 1px dashed #444; cursor: pointer; margin-bottom: 12px;
        }
        .upi-text { font-size: 16px; color: #00e5ff; font-weight: 900; letter-spacing: 0.5px; }
        .tap-msg { font-size: 9px; color: #666; margin-top: 4px; text-transform: uppercase; font-weight: bold; }

        /* DETAILS */
        .info-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .offer-name { font-size: 11px; color: #888; font-weight: bold; }
        .amt-text { font-size: 26px; font-weight: 900; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.1); }

        /* APP GRID */
        .app-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .app-btn { 
            background: #151515; border: 1px solid #333; border-radius: 8px; padding: 10px 0; 
            text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .app-btn:active { background: #333; transform: scale(0.98); }
        .app-btn img { width: 28px; height: 28px; margin-bottom: 4px; }
        .app-lbl { font-size: 9px; font-weight: 900; color: #aaa; text-transform: uppercase; }

        .btn-done { width: 100%; background: #00e5ff; color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: 900; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,229,255,0.2); }

        .loader { text-align: center; padding: 60px; color: #00e5ff; font-weight: bold; font-size: 12px; }
        .hidden { display: none !important; }
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 8px 20px; border-radius: 30px; font-weight: 900; font-size: 10px; display: none; z-index: 9999; }
    </style>
</head>
<body>

<div id="toast">COPIED</div>

<div class="sticky-header">
    <div class="filter-row">
        <button class="filter-btn" id="btn-1" onclick="loadReport(1)">TODAY</button>
        <button class="filter-btn" id="btn-3" onclick="loadReport(3)">48 HRS</button>
        <button class="filter-btn" id="btn-4" onclick="loadReport(4)">7 DAYS</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('tasks')">TASKS (<span id="tc">0</span>)</div>
        <div class="tab" onclick="switchTab('referrals')">REFS (<span id="rc">0</span>)</div>
        <div class="tab" onclick="switchTab('history')">HISTORY</div>
    </div>
</div>

<div class="container">
    <div id="loader" class="loader">ðŸ”’ SECURE LOADING...</div>
    <div id="tasks-area"></div>
    <div id="referrals-area" class="hidden"></div>
    <div id="history-area" class="hidden"></div>
</div>

<script>
    // --- 1. PASSWORD PROTECTION ---
    function checkSecurity() {
        const last = localStorage.getItem('secure_login_ts');
        const now = Date.now();
        if(!last || (now - last > 300000)) { // 5 Minutes
            if(prompt("ENTER PASSWORD:") === "1234") { localStorage.setItem('secure_login_ts', now); }
            else { location.reload(); throw "Denied"; }
        } else { localStorage.setItem('secure_login_ts', now); }
    }
    checkSecurity();

    // --- 2. CONFIG ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfjyg_o0a_BUgiC0Iuoit3OTtzBHhkvVf8kg6XeI0DaCKVpBsbljCbpK-Tbb7uk-Dqvg/exec";
    const AUTH_TOKEN = "8df0570da65f3a1798408c942b82839a";
    
    // MEMORY FOR REPORT SELECTION
    let currentReport = localStorage.getItem('last_rep_id') || 1;
    let paidSet = new Set(), leads = [], offers = {};

    // --- 3. INIT ---
    init();

    async function init() {
        updateFilterUI(currentReport);
        loadReport(currentReport);
    }

    // --- 4. DATA LOADING & FILTERING ---
    async function loadReport(rid) {
        currentReport = rid;
        localStorage.setItem('last_rep_id', rid); // Save Report Choice
        updateFilterUI(rid);
        
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('tasks-area').innerHTML = '';
        
        try {
            // Load Google Sheet Paid List + Offers (Once)
            if(Object.keys(offers).length === 0) {
                const [rSheet, rOffer] = await Promise.all([fetch(SCRIPT_URL), fetch('offers.json')]);
                const dSheet = await rSheet.json();
                const dOffer = await rOffer.json();
                dSheet.forEach(k => paidSet.add(k));
                dOffer.forEach(o => {
                    offers[o.cid || o.id] = { t: o.title, u: parseInt(o.user_payout.replace(/\D/g,'')) || 6, r: parseInt(o.refer_payout.replace(/\D/g,'')) || 2 };
                });
            }

            // PROXY FETCH
            const target = `https://panel.visioncamp.in/api.php?auth-token=${AUTH_TOKEN}&report=${currentReport}`;
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`,
                `https://corsproxy.io/?${encodeURIComponent(target)}`
            ];

            let success = false;
            for(let p of proxies) {
                try {
                    const res = await fetch(p);
                    if(res.ok) {
                        const d = await res.json();
                        leads = d.data || d;
                        success = true;
                        break;
                    }
                } catch(e) {}
            }

            document.getElementById('loader').classList.add('hidden');
            if(success) render();
            else document.getElementById('loader').innerText = "DATA FAILED. REFRESH.";

        } catch(e) { console.log(e); }
    }

    // --- 5. RENDER LOGIC (LOCAL LOCK INCLUDED) ---
    function render() {
        let tA = document.getElementById('tasks-area'), rA = document.getElementById('referrals-area'), hA = document.getElementById('history-area');
        let rG = {}, tc = 0, rc = 0;
        
        // Clear Areas
        tA.innerHTML = ''; rA.innerHTML = ''; hA.innerHTML = '';

        [...leads].reverse().forEach(l => {
            if(l.status.toLowerCase() !== 'approved') return;
            
            let o = offers[l.offerid] || { t: `Offer ${l.offerid}`, u: 6, r: 2 };
            let sk = `${l.p1}_${l.offerid}_SELF`;
            let rk = `${l.p2}_${l.offerid}_REF`;

            // CHECK BOTH: GOOGLE SHEET & LOCAL STORAGE LOCK
            let isPaid = paidSet.has(sk) || localStorage.getItem('PAID_LOCK_' + sk);

            if(isPaid) {
                hA.innerHTML += `<div class="card" style="opacity:0.4; border:1px solid #333;">
                    <div style="color:#00e5ff; font-weight:bold;">${l.p1}</div>
                    <div style="font-size:10px;">PAID â‚¹${o.u}</div>
                </div>`;
            } else {
                tc++;
                tA.innerHTML += createCard(l.p1, o.t, o.u, sk);
            }

            // REFERRAL LOGIC
            if(l.p2 && l.p2.length > 5) {
                if(!rG[l.p2]) rG[l.p2] = { total: 0, keys: [] };
                rG[l.p2].total += o.r;
                rG[l.p2].keys.push(rk);
            }
        });

        // RENDER REFERRALS
        for (let [upi, d] of Object.entries(rG)) {
            // Check if ALL refer keys are paid/locked
            let allPaid = d.keys.every(k => paidSet.has(k) || localStorage.getItem('PAID_LOCK_' + k));
            
            if(allPaid) continue; 
            
            rc++;
            rA.innerHTML += createCard(upi, `${d.keys.length} REFERRALS`, d.total, JSON.stringify(d.keys));
        }

        document.getElementById('tc').innerText = tc;
        document.getElementById('rc').innerText = rc;
    }

    function createCard(upi, title, amt, key) {
        return `
            <div class="card" id="card-${key.replace(/[^a-zA-Z0-9]/g, '')}">
                <div class="upi-box" onclick="copyUPI('${upi}')">
                    <div class="upi-text">${upi}</div>
                    <div class="tap-msg">TAP TO COPY</div>
                </div>

                <div class="info-box">
                    <div class="offer-name">${title}</div>
                    <div class="amt-text">â‚¹${amt}</div>
                </div>

                <div class="app-grid">
                    <div class="app-btn" onclick="openLink('https://fam.one/${upi}')">
                        <img src="https://img.icons8.com/color/48/wallet.png">
                        <div class="app-lbl">FAM WEB</div>
                    </div>
                    <div class="app-btn" onclick="openLink('fampay://')">
                        <img src="https://img.icons8.com/color/48/wallet.png">
                        <div class="app-lbl">FAM APP</div>
                    </div>
                    
                    <div class="app-btn" onclick="openLink('phonepe://')">
                        <img src="https://img.icons8.com/color/48/phone-pe.png">
                        <div class="app-lbl">PE APP</div>
                    </div>
                    
                    <div class="app-btn" onclick="openLink('paytmmp://')">
                        <img src="https://img.icons8.com/color/48/paytm.png">
                        <div class="app-lbl">PTM APP</div>
                    </div>

                    <div class="app-btn" onclick="openLink('upi://pay?pa=${upi}&pn=User&am=${amt}&cu=INR')">
                        <img src="https://img.icons8.com/fluency/48/bhim.png">
                        <div class="app-lbl">ANY PAY</div>
                    </div>
                </div>

                <button class="btn-done" onclick="markPaid('${key}')">âœ… MARK AS PAID</button>
            </div>
        `;
    }

    // --- 6. ACTIONS ---
    function openLink(url) {
        window.location.href = url;
    }

    function copyUPI(txt) {
        navigator.clipboard.writeText(txt);
        const t = document.getElementById('toast');
        t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1000);
    }

    function markPaid(key) {
        if(confirm("Confirm Paid?")) {
            const safeId = key.replace(/[^a-zA-Z0-9]/g, '');
            
            // 1. HIDE INSTANTLY
            const el = document.getElementById(`card-${safeId}`);
            if(el) el.style.display = 'none';

            // 2. LOCK LOCALLY (PERMANENT FIX FOR REFRESH)
            const kArr = key.startsWith('[') ? JSON.parse(key) : [key];
            kArr.forEach(k => {
                localStorage.setItem('PAID_LOCK_' + k, 'true'); // Save to phone memory
                // 3. SEND TO SERVER
                fetch(SCRIPT_URL + `?action=pay&key=${encodeURIComponent(k)}`, { mode: 'no-cors' });
            });
        }
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        ['tasks-area','referrals-area','history-area'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(t + '-area').classList.remove('hidden');
    }

    function updateFilterUI(id) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('btn-' + id);
        if(btn) btn.classList.add('active');
    }
</script>
</body>
</html>
