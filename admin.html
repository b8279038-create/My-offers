<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° ULTIMATE ADMIN - INFINITE CONNECT</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- FULL STYLING (‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§∞‡§ñ‡§æ ‡§π‡•à) --- */
        body { margin: 0; background: #000; font-family: 'Poppins', sans-serif; color: white; padding-bottom: 80px; }
        .container { max-width: 600px; margin: auto; padding: 12px; }
        .header { 
            background: #111; padding: 18px; border-bottom: 1px solid #222; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .tabs { display: flex; gap: 6px; margin: 15px 0; background: #1a1a1a; padding: 5px; border-radius: 12px; }
        .tab-btn { 
            flex: 1; padding: 12px; border: none; background: none; 
            color: #777; font-weight: 700; font-size: 11px; border-radius: 9px; 
            cursor: pointer; transition: 0.3s; 
        }
        .tab-btn.active { background: #0072ff; color: #fff; box-shadow: 0 0 10px #0072ff; }
        
        .card { 
            background: #111; padding: 16px; border-radius: 18px; 
            margin-bottom: 12px; border: 1px solid #222; animation: fadeIn 0.5s; 
        }
        .upi-txt { font-size: 14px; font-weight: 700; color: #00c6ff; word-break: break-all; }
        .offer-txt { font-size: 11px; color: #666; margin-top: 2px; }
        .amt-txt { font-size: 20px; font-weight: 900; color: #fff; }
        
        .btn-main { 
            background: #fff; color: #000; border: none; padding: 12px; 
            border-radius: 12px; font-weight: 900; width: 100%; margin-top: 12px; 
            cursor: pointer; transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }
        
        .loader { 
            text-align: center; margin-top: 50px; color: #0072ff; 
            font-weight: 900; font-size: 14px; padding: 20px; border: 1px dashed #333; border-radius: 10px;
        }
        .hidden { display: none; }
        .card-history { opacity: 0.4; filter: grayscale(1); border: 1px solid #333; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-weight:900; letter-spacing: 1px;">‚ö° ADMIN PRO</div>
            <div id="status" style="font-size:10px; color:#00ff00; border:1px solid #00ff00; padding:2px 6px; border-radius:4px;">‚óè AUTO-RETRY ON</div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tasks')">TASKS (<span id="count-t">0</span>)</button>
            <button class="tab-btn" onclick="switchTab('referrals')">REFS (<span id="count-r">0</span>)</button>
            <button class="tab-btn" onclick="switchTab('history')">HISTORY</button>
        </div>

        <div id="loader" class="loader">üöÄ STARTING ENGINES...</div>
        
        <div id="tasks-area"></div>
        <div id="referrals-area" class="hidden"></div>
        <div id="history-area" class="hidden"></div>
    </div>

    <script>
        // --- ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (Settings) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfjyg_o0a_BUgiC0Iuoit3OTtzBHhkvVf8kg6XeI0DaCKVpBsbljCbpK-Tbb7uk-Dqvg/exec";
        const API_URL = "https://panel.visioncamp.in/api.php?auth-token=8df0570da65f3a1798408c942b82839a&report=1";
        
        let paidSet = new Set(), leads = [], offers = {};

        // --- 1. INFINITE PROXY LOOP (‡§ï‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§∞‡•Å‡§ï‡•á‡§ó‡§æ) ---
        async function fetchWithInfiniteRetry(url) {
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}&v=${Date.now()}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`,
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
                `https://thingproxy.freeboard.io/fetch/${url}`
            ];

            let index = 0;
            let attempt = 1;

            while (true) { // ‡§Ö‡§®‡§Ç‡§§ ‡§≤‡•Ç‡§™ (Infinite Loop)
                let currentProxy = proxies[index];
                try {
                    document.getElementById('loader').innerHTML = `üîÑ Connecting...<br><span style="font-size:10px;color:#777">Attempt ${attempt} | Proxy ${index + 1}</span>`;
                    
                    const response = await fetch(currentProxy);
                    if (response.ok) {
                        const data = await response.json();
                        return data.data || data; // ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ! ‡§≤‡•Ç‡§™ ‡§§‡•ã‡§°‡§º‡•ã ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú‡•ã
                    }
                } catch (e) {
                    console.log(`Proxy ${index + 1} failed.`);
                }

                // ‡§Ö‡§ó‡§≤‡•á ‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§™‡§∞ ‡§∏‡•ç‡§µ‡§ø‡§ö ‡§ï‡§∞‡•ã
                index = (index + 1) % proxies.length;
                attempt++;

                // ‡§Ö‡§ó‡§∞ 4 ‡§ï‡•á 4 ‡§´‡•á‡§≤ ‡§π‡•ã ‡§ó‡§è, ‡§§‡•ã 3 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§∞‡•Å‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•ã (Loop Back)
                if (index === 0) {
                    document.getElementById('loader').innerHTML = `‚ö†Ô∏è High Traffic. Waiting 3s...`;
                    await new Promise(r => setTimeout(r, 3000));
                }
            }
        }

        // --- 2. STARTUP SEQUENCE ---
        async function init() {
            try {
                // ‡§™‡§π‡§≤‡•á ‡§ó‡•Ç‡§ó‡§≤ ‡§∂‡•Ä‡§ü ‡§î‡§∞ ‡§ë‡§´‡§∞‡•ç‡§∏ ‡§≤‡§æ‡§ì
                document.getElementById('loader').innerText = "üìÇ Loading History & Offers...";
                const [rSheet, rOffer] = await Promise.all([
                    fetch(SCRIPT_URL),
                    fetch('offers.json')
                ]);
                
                const dSheet = await rSheet.json();
                const dOffer = await rOffer.json();
                
                // Paid History Set ‡§ï‡§∞‡§®‡§æ
                dSheet.forEach(k => paidSet.add(k));
                
                // Offers Map ‡§ï‡§∞‡§®‡§æ (‡§§‡§æ‡§ï‡§ø 122 ‡§î‡§∞ 123 ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§Ç)
                dOffer.forEach(o => {
                    offers[o.cid || o.id] = { 
                        t: o.title, 
                        u: parseInt(o.user_payout.replace(/\D/g,'')) || 0, 
                        r: parseInt(o.refer_payout.replace(/\D/g,'')) || 0 
                    };
                });
                
                // ‡§Ö‡§¨ ‡§≤‡•Ä‡§°‡•ç‡§∏ ‡§≤‡§æ‡§ì (Infinite Loop ‡§µ‡§æ‡§≤‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•â‡§≤)
                await loadLeads();

            } catch(e) { 
                console.error(e);
                // ‡§Ö‡§ó‡§∞ offers.json ‡§π‡•Ä ‡§® ‡§Æ‡§ø‡§≤‡•á ‡§§‡•ã ‡§≠‡•Ä ‡§∞‡•Ä‡§ü‡•ç‡§∞‡§æ‡§Ø ‡§ï‡§∞‡•ã
                setTimeout(init, 3000); 
            }
        }

        async function loadLeads() {
            leads = await fetchWithInfiniteRetry(API_URL);
            if(Array.isArray(leads)) {
                render();
            } else {
                // ‡§Ö‡§ó‡§∞ ‡§°‡•á‡§ü‡§æ ‡§Ö‡§ú‡•Ä‡§¨ ‡§Ü‡§Ø‡§æ ‡§§‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ü‡•ç‡§∞‡§æ‡§à ‡§ï‡§∞‡•ã
                setTimeout(loadLeads, 2000);
            }
        }

        // --- 3. RENDER LOGIC (Everything included) ---
        function render() {
            let tA = document.getElementById('tasks-area'), 
                rA = document.getElementById('referrals-area'), 
                hA = document.getElementById('history-area');
            let rG = {}, tc = 0, rc = 0;
            
            tA.innerHTML = ''; rA.innerHTML = ''; hA.innerHTML = '';

            // ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§â‡§≤‡•ç‡§ü‡§æ ‡§≤‡•Ç‡§™ ‡§ï‡§∞‡§®‡§æ (Newest First)
            leads.reverse().forEach(l => {
                if(l.status.toLowerCase() !== 'approved') return;
                
                let o = offers[l.offerid] || { t: `Offer #${l.offerid}`, u: 0, r: 0 };
                let sk = `${l.p1}_${l.offerid}_SELF`; // Task Key
                let rk = `${l.p2}_${l.offerid}_REF`;  // Refer Key

                // --- TASK DISPLAY ---
                if(paidSet.has(sk)) {
                    hA.innerHTML += createHistoryCard(l.p1, o.t, o.u, "TASK");
                } else {
                    tc++;
                    tA.innerHTML += `<div class="card">
                        <div style="display:flex;justify-content:space-between">
                            <div><div class="upi-txt">${l.p1}</div><div class="offer-txt">${o.t}</div></div>
                            <div class="amt-txt">‚Çπ${o.u}</div>
                        </div>
                        <button class="btn-main" onclick="copyAndPaid('${l.p1}','${sk}',this)">COPY & MARK PAID</button>
                    </div>`;
                }

                // --- REFERRAL DISPLAY (Deep Logic) ---
                if(l.p2 && l.p2.trim() !== "" && l.p2 !== "null") {
                    if(paidSet.has(rk)) {
                        hA.innerHTML += createHistoryCard(l.p2, o.t, o.r, "REF");
                    } else {
                        // ‡§∞‡•á‡§´‡§∞‡§≤ ‡§ó‡•ç‡§∞‡•Å‡§™‡§ø‡§Ç‡§ó (Grouping logic to combine same UPI)
                        if(!rG[l.p2]) rG[l.p2] = { total: 0, items: [] };
                        rG[l.p2].total += o.r;
                        rG[l.p2].items.push({ t: o.t, r: o.r, k: rk });
                    }
                }
            });

            // Pending Referrals ‡§ï‡•ã ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡§æ
            for (let [upi, d] of Object.entries(rG)) {
                rc++;
                let ks = JSON.stringify(d.items.map(i => i.k)); // ‡§∏‡§æ‡§∞‡•Ä Keys ‡§è‡§ï ‡§∏‡§æ‡§•
                rA.innerHTML += `<div class="card">
                    <div style="display:flex;justify-content:space-between">
                        <div><div class="upi-txt">${upi}</div><div class="offer-txt">${d.items.length} Pending Referrals</div></div>
                        <div class="amt-txt" style="color:#ffd700">‚Çπ${d.total}</div>
                    </div>
                    <button class="btn-main" style="background:#ffd700" onclick='copyAndPaid("${upi}",${ks},this)'>COPY & MARK PAID ALL</button>
                </div>`;
            }

            document.getElementById('count-t').innerText = tc;
            document.getElementById('count-r').innerText = rc;
            document.getElementById('loader').style.display = 'none';
        }

        // --- 4. HELPERS ---
        function createHistoryCard(u, t, a, type) {
            return `<div class="card card-history"><div style="display:flex;justify-content:space-between"><div><div class="upi-txt" style="color:#666">${u}</div><div style="font-size:10px;color:#444">${type}: ${t}</div></div><div style="font-weight:900;color:#00c851">‚Çπ${a} PAID</div></div></div>`;
        }

        window.copyAndPaid = function(upi, keys, btn) {
            navigator.clipboard.writeText(upi);
            let confirmAction = confirm("‚úÖ UPI Copied: " + upi + "\n\n‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§®‡•á ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ? (OK ‡§¶‡§¨‡§æ‡§§‡•á ‡§π‡•Ä ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã‡§ó‡•Ä)");
            if (confirmAction) {
                btn.innerText = "SAVING...";
                btn.style.opacity = "0.5";
                const kArr = Array.isArray(keys) ? keys : [keys];
                
                // ‡§ó‡•Ç‡§ó‡§≤ ‡§∂‡•Ä‡§ü ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§≠‡•á‡§ú‡§®‡§æ (Sequential Request)
                kArr.forEach((k, i) => {
                    setTimeout(() => {
                        fetch(SCRIPT_URL + `?action=pay&key=${encodeURIComponent(k)}`, { mode: 'no-cors' });
                    }, i * 400);
                });

                // 2.5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§¨‡§æ‡§¶ ‡§™‡•á‡§ú ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂
                setTimeout(() => location.reload(), 2500);
            }
        }

        window.switchTab = function(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['tasks-area','referrals-area','history-area'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(t + '-area').classList.remove('hidden');
        }
        
        // ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü
        init();
    </script>
</body>
</html>
